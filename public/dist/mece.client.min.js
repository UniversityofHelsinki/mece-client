var meceClientApp=function(){"use strict";function e(e,n){if("undefined"!=typeof moment)return moment(e).locale(n).calendar()}function n(e){fe&&console.log("module: MECE-CLIENT -- "+e+" : "+Date().toString())}function t(){ue(document).ready(function(){N=ue(me).append(String.format(meceClientApp.Templates.containerTemplate,re)),U=N.find(".mece"),H=N.find(".mece-content-wrapper"),A=U.find(".mece-content"),R=U.find(".mece-icon"),q=U.find(".mece-badge"),F=U.find(".mece-row-container--no-messages"),a(),u(),b(),C(),o()})}function i(e){q.text(e)}function a(){n("initializerStuff in"),f();var e=N.data("language");!e||"fi"!==e&&"sv"!==e&&"en"!==e||($=e),g(),n("initializerStuff out")}function o(){n("start"),c(),y(),V=setInterval(function(){c(),y()},O)}function s(e,t){t&&401===t.status&&(n("stopInterval, status 401"),clearInterval(e))}function c(){n("fetchNotifications"),r().done(function(e){d(e),h()}).fail(function(e){s(V,e),n("ERROR "+JSON.stringify(e)),w()})}function r(){var e={};"0"!==B&&(e.startingTime=B),e.token=_,e.host=W;var t=Q+"/mece/api/notifications?"+ue.param(e);return ue.ajax({url:t,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){return z+=e.length,e},error:function(e,t,i){n(e.responseText)}})}function d(e){var n,t=e;t&&t.length>0&&l(t),t.sort(function(e,n){return new Date(e.submitted)-new Date(n.submitted)}),t.length>0&&Y(t.map(function(e){return n={en:{heading:e.headingEN,message:e.messageEN,linkUrl:e.linkUrlEN,linkText:e.linkTextEN},fi:{heading:e.headingFI,message:e.messageFI,linkUrl:e.linkUrlFI,linkText:e.linkTextFI},sv:{heading:e.headingSV,message:e.messageSV,linkUrl:e.linkUrlSV,linkText:e.linkTextSV}},[e._id,e.message,e.linkUrl,e.linkText,e.heading,e.avatarImageUrl,e.received,G?n:{en:{},fi:{},sv:{}},e.submitted,e.read]}))}function l(e){ue.each(e,function(e,n){B<n.received&&(B=n.received)})}function m(){var e=N.data("polling-interval");return e&&e>O?e:O}function u(){O=m(),Q=N.data("domain")||X,W=N.data("host")||K,_=N.data("token"),fe=N.data("enable-debug")||!1}function f(){if(void 0===window.moment){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src",he),(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)}}function v(){var e;void 0===window.jQuery||window.jQuery.fn.jquery!==J?(e=document.createElement("script"),e.setAttribute("type","text/javascript"),e.setAttribute("src",we),e.readyState?e.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||(ue=window.jQuery.noConflict(!0),n("jQuery loaded"),t())}:e.onload=function(){ue=window.jQuery.noConflict(!0),n("browsers"),t()},(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)):(ue=window.jQuery,n("The jQuery version on the window is the one we want to use"),t())}function g(){function e(){"undefined"!=typeof moment?(moment.locale("fi",{calendar:{sameDay:function(){return"["+moment(this).locale("fi").fromNow()+"]"},nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"}}),moment.locale("sv",{calendar:{sameDay:function(){return"["+moment(this).locale("sv").fromNow()+"]"},nextDay:"[Imorgon] LT",lastDay:"[Igår] LT",nextWeek:"[På] dddd LT",lastWeek:"[I] dddd[s] LT",sameElse:"L"}}),moment.locale("en",{calendar:{sameDay:function(){return"["+moment(this).locale("en").fromNow()+"]"},nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"}}),y()):setTimeout(function(){e()},250)}e()}function p(e,t){var i=le[e][t||$];return n("Translation: "+i),i}function h(){U.toggleClass(ke.noMessages,0===T()),F.html(p("no_messages")),k(!1)}function w(){U.toggleClass(ke.noMessages,0===T()),F.html(p("no_messages"))}function k(e){var n=x().filter(":not(.mece-row-container--read)").length-1;U.toggleClass(ke.hasUnreads,0!==n),i(n)}function T(){return x().length-1}function x(){return A.children(".mece-row-container")}function y(){A.children(".mece-row-container").each(function(){var n=ue(this).find(".mece-hidden-submitted-time").first().text(),t=ue(this).find("."+de).first();t&&n&&t.text(e(n,$))})}function L(e,t){n("Seeking field "+e+" for language "+$);var i={fi:"sv",sv:"en",en:"fi"},a=$,o=t[oe][a][e];return o&&"undefined"!==o||(a=i[a],o=t[oe][a][e]),o&&"undefined"!==o||(a=i[a],o=t[oe][a][e]),o}function j(n){var t,i=function(){var e=n[ae];return e||pe},a=L("linkUrl",n)||n[te],o=L("message",n)||n[ne],s=L("heading",n)||n[ie];a=void 0===a||"undefined"===a?"":a,o=void 0===o||"undefined"===o?"&nbsp;":o,s=void 0===s||"undefined"===s?"&nbsp;":s,t=""===a?s:'<a target="_blank" href="'+a+'">'+s+"</a>";var c=String.format(meceClientApp.Templates.rowTemplate,n[ee],i(),t,o,e(n[se],$),n[se],n[ce]?" "+Te.hasReads:"",n[ce]?"mece-para-ellipsis--read":"mece-para-ellipsis");A.prepend(c)}function C(){A.on("click",".mece-row-container",function(){var e=ue(this);if(!e.hasClass(Te.hasReads)&&!e.hasClass(Te.noMessages)){var n={};n.token=_,n.id=this.id,n.host=W;var t=Q+"/mece/api/notifications/markRead?"+ue.param(n);ue.ajax({url:t,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(n){e.addClass("mece-row-container--read"),e.find(".mece-para-ellipsis").toggleClass("mece-para-ellipsis--read"),k(!1)},error:function(e,n,t){console.log(e.responseText)}})}})}function b(){R.click(function(e){if(ge=!ge,e.stopPropagation(),U.toggleClass(ke.open,ge),ue("html").toggleClass(ke.html,ge),S()){var n=!!navigator.userAgent.match(/like Mac OS X/i),t=H.offset().top;H.css("max-height","calc(100vh - "+t+"px)"),n?(E(t),M(t)):A.css("max-height","calc(100vh - "+t+"px)"),D(document.querySelector(".mece-content"))}S()||(H.css("max-height",Z),A.css("max-height",Z))})}function E(e){window.matchMedia("(orientation: portrait)").matches&&A.css("max-height","calc(100vh - "+(e+60)+"px)"),window.matchMedia("(orientation: landscape)").matches&&A.css("max-height","calc(100vh - "+(e+30)+"px)")}function M(e){window.addEventListener("orientationchange",function(){E(e)},!1)}function D(e){e&&e.addEventListener("touchstart",function(){var n=e.scrollTop;0===n&&(e.scrollTop=1),e.scrollTop+e.clientHeight===e.scrollHeight&&(e.scrollTop=n-1)})}function S(){return!!(ge&&window.innerWidth<P)}function Y(e){ue.each(e,function(e,n){j(n)})}function I(){ve||(n("loading widget"),v(),ve=!0)}var N,U,A,H,R,F,Q,W,_,q,V,O=6e4,z=0,B="0",G=!0,P=768,J="1.11.3",X="https://mece.it.helsinki.fi",K="opintoni",Z="330px",$="fi",ee=0,ne=1,te=2,ie=4,ae=5,oe=7,se=8,ce=9,re="https://mece.it.helsinki.fi/dist/prod/images",de="mece-row-content-received",le={no_messages:{en:"No messages",fi:"Ei viestejä",sv:"Inga meddelanden"}},me="#mece",ue=null,fe=!1,ve=!1,ge=!1,pe="https://rawgit.com/UniversityofHelsinki/Styleguide/master/icons/src/avatar.svg",he="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment-with-locales.min.js",we="https://ajax.googleapis.com/ajax/libs/jquery/"+J+"/jquery.min.js",ke={open:"mece--open",hasUnreads:"mece--has-unreads",noMessages:"mece--no-messages",html:"mece--open-html"},Te={hasReads:"mece-row-container--read",noMessages:"mece-row-container--no-messages"};return String.format=function(){for(var e=arguments[0],n=0;n<arguments.length-1;n++){var t=new RegExp("\\{"+n+"\\}","gm");e=e.replace(t,arguments[n+1])}return e},{startClient:I}}();meceClientApp.Templates={},meceClientApp.Templates.containerTemplate='<div class="mece">        <div class="mece-icon-container">            <div class="mece-icon mece-icon-bell">                <img src="{0}/bell.svg">                <div class="mece-badge"></div>            </div>            <div class="mece-icon mece-icon-close">                <img src="{0}/close.svg">            </div>        </div>        <div class="mece-content-wrapper">            <div class="mece-content">                <div class="mece-row-container mece-row-container--no-messages">                </div>            </div>        </div>        <div id="mece-mobile-cover" class="mece-mobile-cover"></div>        <div id="mece-mobile-cover-top" class="mece-mobile-cover-top"></div>    </div>',meceClientApp.Templates.rowTemplate='<div class="mece-row-container{6}" id="{0}">        <div class="mece-row mece-row--no-margins mece-top-xs"> <!--yksi rivi, jossa kaksi(kolme) kolumnia-->            <div> <!--Column 1 (kuva) flouttaava divi joka asettuu sisaltonsa kokoiseksi-->                <div class="mece-row-avatar mece-padding">                    <img class="mece-row-avatar-picture" alt="avatar" src="{1}">                </div>            </div>            <div class="mece-col-xs"> <!--Column 2 (sisalto) venyy-->                <div class="mece-row-content mece-padding">                    <div class="mece-row-content-title mece-h3 mece-text-ellipsis">                       {2}                    </div>                    <div class="mece-row-content-para {7}">{3}</div>                    <div class="mece-row-content-received">{4}</div>                </div>            </div>            <div> <!--flouttaava divi joka asettuu sisaltonsa kokoiseksi-->                <div class="mece-row-actions">                </div>            </div>                <div class="mece-hidden-submitted-time mece-hidden">{5}</div>        </div>    </div>';