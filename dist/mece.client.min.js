var meceNotifications=function(e){function t(e){console.log("module: SHIBBOLOGIN -- "+e+" : "+Date().toString())}function n(){t("createIframe");var n=document.createElement("iframe");n.style.display="none",n.src=e.login_url,n.addEventListener("load",function(){setTimeout(function(){t("loggedIn"),e.loggedIn=!0,e.controller&&(t("mece.controller"),e.controller.init()),e.view&&(t("mece.view"),e.view.init())},1e3)},!1),n.addEventListener("error",function(){t("error")},!1),document.body.appendChild(n),t("createIframe out")}var i="https://mece.it.helsinki.fi/Shibboleth.sso/HYLogin";return e.login_url=e.jQuery(e.contentDivId).attr("meceLoginUrl")||i,n(),e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: CONTROLLER -- "+e+" : "+Date().toString())}function n(){return u(e.contentDivId).attr("pollingInterval")||f}function i(){return u(e.contentDivId).attr("meceChannels")||p}function o(){m=n(),e.channels=i()}function a(){t("init"),e.initializer&&e.initializer.ready&&e.view&&e.view.ready&&!e.controller.ready&&c()&&(t("init !mece.controller.ready && dependenciesLoaded()"),u=e.jQuery,o(),l(),e.controller.ready=!0),t("init out")}function c(){return e.initializer&&e.initializer.ready&&e.loggedIn}function s(){var t={channelNames:e.channels.split(v).map(function(e){return e.trim()})};"0"!==g&&(t.startingTime=g);var n=e.domain+"/mece/notifications?"+u.param(t);return u.ajax({url:n,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){return e},error:function(e,t,n){console.log(e.responseText)}})}function d(e){var t=e;t&&t.length>0&&(g=t[0].received),t.sort(function(e,t){return new Date(e.submitted)-new Date(t.submitted)}),t.length>0&&meceNotifications.view.notifications.add(t.map(function(e){var t={en:{heading:e.headingEN,message:e.messageEN,link:e.linkEN,linkText:e.linkTextEN},fi:{heading:e.headingFI,message:e.messageFI,link:e.linkFI,linkText:e.linkTextFI},sv:{heading:e.headingSV,message:e.messageSV,link:e.linkSV,linkText:e.linkTextSV}};return[e._id,e.message,e.link,e.linkText,e.heading,e.avatarImageUrl,e.received,e._recipients?e._recipients[0]:null,h?t:{en:{},fi:{},sv:{}},e.submitted]}))}function r(){s().done(function(e){d(e)},function(e){})}function l(){e.controller.running||(meceNotifications.view.notifications.updateTime(),r(),meceNotifications.view.notifications.check(),setInterval(function(){meceNotifications.view.notifications.updateTime(),r(),meceNotifications.view.notifications.check()},m),e.controller.running=!0)}var m,u,f=4e3,p="",v=",",g="0",h=!0;return function(){t("bootstrap"),e.controller={init:a,start:l},e.controller.init(),t("bootstrap out")}(),e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: INITIALIZER -- "+e+" : "+Date().toString())}function n(){t("init"),e.initializer.ready=!0,e.domain=e.jQuery(e.contentDivId).attr("meceDomain")||s,e.config.windowLeftOffset=parseInt(e.jQuery(e.contentDivId).attr("meceWindowLeftOffset"))||d,e.config.windowTopOffset=parseInt(e.jQuery(e.contentDivId).attr("meceWindowTopOffset"))||l,e.config.windowTopOffsetCollapsed=parseInt(e.jQuery(e.contentDivId).attr("meceWindowTopOffsetCollapsed"))||MECE_DEFAULT_WINDOW_TOP_OFFSET_COLLAPSED,e.config.windowWidth=parseInt(e.jQuery(e.contentDivId).attr("meceWindowWidth"))||m,e.config.windowHeight=parseInt(e.jQuery(e.contentDivId).attr("meceWindowHeight"))||u,e.config.collapseWidth=parseInt(e.jQuery(e.contentDivId).attr("meceCollapseWidth"))||r,e.controller&&(t("mece.controller"),e.controller.init()),e.view&&(t("mece.view"),e.view.init()),t("init out")}function i(){if(void 0===window.moment){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src","https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment-with-locales.min.js"),(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)}}function o(){if(void 0===window.jQuery||window.jQuery.fn.jquery!==c){var i=document.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("src","https://ajax.googleapis.com/ajax/libs/jquery/"+c+"/jquery.min.js"),i.readyState?i.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&(e.jQuery=window.jQuery.noConflict(!0),t("jQuery loaded"),n())}:i.onload=function(){e.jQuery=window.jQuery.noConflict(!0),t("browsers"),n()},(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(i)}else e.jQuery=window.jQuery,t("The jQuery version on the window is the one we want to use"),n()}function a(){function e(){"undefined"!=typeof moment?(moment.locale("fi",{calendar:{sameDay:function(){return"["+moment(this).locale("fi").fromNow()+"]"},nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"}}),moment.locale("sv",{calendar:{sameDay:function(){return"["+moment(this).locale("sv").fromNow()+"]"},nextDay:"[Imorgon] LT",lastDay:"[Igår] LT",nextWeek:"[På] dddd LT",lastWeek:"[I] dddd[s] LT",sameElse:"L"}}),moment.locale("en",{calendar:{sameDay:function(){return"["+moment(this).locale("en").fromNow()+"]"},nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"}})):setTimeout(function(){e()},250)}e()}var c="1.11.3",s="https://mece.it.helsinki.fi",d=250,r=450,l=35,m=300,u=350;return e.contentDivId="#mece-content-div",e.iconDivId="#mece-icon-div",e.unreadCountSpanId="#unread-count",e.jQuery=null,e.config={},function(){t("bootstrap"),e.initializer={init:n},i(),a(),o(),t("bootstrap out")}(),e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: VIEW -- "+e+" : "+Date().toString())}function n(e,t){return C[e][t||v]}function i(){var t=e.config.windowWidth,n=e.config.windowHeight,i=p("#mece").position().left,o=p(window).width(),a="relative",c=0,s="50px",d=p("#mece").position().top+e.config.windowTopOffset;o<e.config.collapseWidth?(s="100%",a="absolute",t="100%",c=0,d=p("#mece").position().top+e.config.windowTopOffsetCollapsed):t>o?(a="absolute",t=o+"px",c=-i):i+t/2>o?(a="absolute",c=o-i-t):t/2>i?(a="absolute",c=-i):(a="absolute",c=-t/2),p("#mece").css("position","relative").css("width",s),p(e.contentDivId).css("position",a).css("left",c+"px").css("overflow-x","visible").css("top",d+"px").css("width",t).css("height",n)}function o(){p(e.contentDivId).append(p("<ul/>").css("height",e.config.windowHeight+"px").css("overflow","auto").css("position","absolute").addClass("mece-list")),p(e.contentDivId).append(p("<div/>").attr("ID","meceNoNotificationsDiv")),i()}function a(){0===p(e.contentDivId).find("li").length?p("#meceNoNotificationsDiv").text(n("no_messages")):p("#meceNoNotificationsDiv").text(""),d(!1)}function c(){p(e.contentDivId).find("ul").each(function(){p(this).find("li").each(function(){var e=p(this).find(".hiddenSubmittedTime").first().text(),t=p(this).find("."+k).first();t&&e&&t.text(b(e,v))})})}function s(t,n){var i=function(){var e=j+(n[T]?"/avatar.png":"/avatar-group.png"),t=n[D];return t||e},o=p(e.contentDivId).find("ul"),a=n[L][v].link||n[w],c=n[L][v].linkText||n[y],s=n[L][v].message||n[h],d=(n[L][v].link||n[I],p("<div>").html(c).contents()),r=p("<a>").attr("href",a);r.prepend(d);var l=p("<img>").attr("src",i()).text("avatar image").addClass("mece-avatar-picture"),m=p("<div>").addClass("mece-avatar").append(l),u=p("<div>").append(r).addClass("mece-msg-title"),f=p("<div>").html(s).addClass("mece-msg-content"),k=p("<div>").text(b(n[x],v)).addClass("mece-msg-received"),C=p("<div>").addClass("mece-notification-fields").append(u).append(f).append(k),N=p("<div style='display: none' class='hiddenSubmittedTime'>").text(n[x]),E=p("<div>").addClass("mece-notification-detail-view").append(m).append(C).append(N),S=p("<li>").attr("id",n[g]).addClass("mece-msg-item");n[T]?S.addClass("mece-private-message"):S.addClass("mece-public-message"),n[T]&&n[T].read&&S.addClass("mece-read-message"),S.prepend(E),o.prepend(S)}function d(t){var n=p(e.contentDivId).find("ul li.mece-private-message").filter("li:not(.mece-read-message)").length;0===p(e.unreadCountSpanId).length?p(e.iconDivId).append(p("<span>").attr("id","unread-count").text(n).addClass("mece-badge")):p(e.unreadCountSpanId).text(n),0===n&&p(e.unreadCountSpanId).remove()}function r(){p(document).ready(function(){p("ul").on("click","li.mece-private-message",function(){p.ajax({url:e.domain+"/mece/notifications/markRead/"+this.id,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){p("#"+e._id).addClass("mece-read-message"),d(!1)},error:function(e,t,n){console.log(e.responseText)}})})})}function l(){function n(){p(".dialog").fadeOut(200),p(e.iconDivId).removeClass("active")}t("dialog"),p(e.iconDivId).append(p("<img>").attr("src",j+"/bell.png").text("bell image")),p(e.iconDivId).click(function(e){e.stopPropagation(),p(this).hasClass("active")?(p(".dialog").fadeOut(200),p(this).removeClass("active")):(p(".dialog").delay(25).fadeIn(200),p(this).addClass("active"))}),p(document.body).click(function(e){n()}),p(".dialog").click(function(e){e.stopPropagation()}),t("dialog out")}function m(){t("init"),!e.view.ready&&u()&&(t("init !mece.view.ready && dependenciesLoaded()"),p=p||e.jQuery,o(),d(!0),l(),r(),e.controller&&e.controller.initialized&&e.controller.start(),e.view.ready=!0,v=p(e.contentDivId).attr("language")||v,p(document).load(p(window).bind("resize",i))),t("init out")}function u(){return e.initializer&&e.initializer.ready&&e.loggedIn}function f(e){p.each(e,function(e,t){s(e,t)})}var p,v="fi",g=0,h=1,w=2,y=3,I=4,D=5,T=7,L=8,x=9,j="https://rawgit.com/UniversityofHelsinki/mece-client/master/images",k="mece-msg-received",C={no_messages:{en:"No messages",fi:"Ei viestejä",sv:"Inga meddelanden"}},b=function(e,t){return moment(e).locale(t).calendar()};return function(){t("bootstrap"),e.view={init:m,notifications:{add:f,check:a,updateTime:c}},e.view.init(),t("bootstrap out")}(),e}(meceNotifications||{});