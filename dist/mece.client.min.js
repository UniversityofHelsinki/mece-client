var meceNotifications=function(e){function t(e){console.log("module: SHIBBOLOGIN -- "+e+" : "+Date().toString())}function n(){t("createIframe");var n=document.createElement("iframe");n.style.display="none",n.src=i,n.addEventListener("load",function(){setTimeout(function(){t("loggedIn"),e.loggedIn=!0,e.controller&&(t("mece.controller"),e.controller.init()),e.view&&(t("mece.view"),e.view.init())},1e3)},!1),n.addEventListener("error",function(){t("error")},!1),document.body.appendChild(n),t("createIframe out")}var i="https://ohtu-devel.it.helsinki.fi/Shibboleth.sso/HYLogin";return n(),e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: CONTROLLER -- "+e+" : "+Date().toString())}function n(){return l(e.contentDivId).attr("pollingInterval")||u}function i(){return l(e.contentDivId).attr("meceChannels")||f}function o(){d=n(),e.channels=i()}function a(){t("init"),!e.controller.ready&&c()&&(t("init !mece.controller.ready && dependenciesLoaded()"),l=l||e.jQuery,o(),s(),e.controller.ready=!0),t("init out")}function c(){return e.initializer&&e.initializer.ready&&e.loggedIn}function r(){var t={channelNames:e.channels.split(v).map(function(e){return e.trim()})};"0"!==g&&(t.startingTime=g);var n=m+"/notifications?"+l.param(t);return l.ajax({url:n,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){return e},error:function(e,t,n){console.log(e.responseText)}})}function s(){t("start"),e.controller.running||(setInterval(function(){r().done(function(e){var t=e;t.sort(function(e,t){return e.submitted>t.submitted}),t.length>0&&(g=t[t.length-1].received,meceNotifications.view.notifications.add(t.map(function(e){var t={en:{heading:e.headingEN,message:e.messageEN,link:e.linkEN,linkText:e.linkTextEN},fi:{heading:e.headingFI,message:e.messageFI,link:e.linkFI,linkText:e.linkTextFI},sv:{heading:e.headingSV,message:e.messageSV,link:e.linkSV,linkText:e.linkTextSV}};return[e._id,e.message,e.link,e.linkText,e.heading,e.avatar,e.received,e._recipients?e._recipients[0]:null,p?t:{en:{},fi:{},sv:{}}]})))},function(e){}),meceNotifications.view.notifications.check()},d),e.controller.running=!0)}var d,l,m="https://ohtu-devel.it.helsinki.fi/mece",u=4e3,f="",v=",",g="0",p=!0;return function(){t("bootstrap"),e.controller={init:a,start:s},e.controller.init(),t("bootstrap out")}(),e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: INITIALIZER -- "+e+" : "+Date().toString())}function n(){t("init"),e.initializer.ready=!0,e.controller&&(t("mece.controller"),e.controller.init()),e.view&&(t("mece.view"),e.view.init()),t("init out")}function i(){if(void 0===window.moment){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src","https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment-with-locales.min.js"),(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)}}function o(){if(void 0===window.jQuery||window.jQuery.fn.jquery!==c){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src","https://ajax.googleapis.com/ajax/libs/jquery/"+c+"/jquery.min.js"),t.readyState?t.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&(e.jQuery=window.jQuery.noConflict(!0),console.log(e.jQuery),n())}:t.onload=function(){e.jQuery=window.jQuery.noConflict(!0),n()},(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(t)}else e.jQuery=window.jQuery,n()}function a(){function e(){"undefined"!=typeof moment?(moment.locale("fi",{calendar:{sameDay:function(){return"["+moment(this).locale("fi").fromNow()+"]"},nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"}}),moment.locale("sv",{calendar:{sameDay:function(){return"["+moment(this).locale("sv").fromNow()+"]"},nextDay:"[Imorgon] LT",lastDay:"[Igår] LT",nextWeek:"[På] dddd LT",lastWeek:"[I] dddd[s] LT",sameElse:"L"}}),moment.locale("en",{calendar:{sameDay:function(){return"["+moment(this).locale("en").fromNow()+"]"},nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"}})):setTimeout(function(){e()},250)}e()}var c="1.11.3";return e.contentDivId="#mece-content-div",e.iconDivId="#mece-icon-div",e.unreadCountSpanId="#unread-count",e.jQuery=null,function(){t("bootstrap"),e.initializer={init:n},i(),a(),o(),t("bootstrap out")}(),e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: VIEW -- "+e+" : "+Date().toString())}function n(e,t){return p[e][t||g]}function i(){t("__initWidgetList"),u(e.contentDivId).append(u("<ul/>").addClass("mece-list")),u(e.contentDivId).append(u("<div/>").attr("ID","meceNoNotificationsDiv")),u(e.contentDivId).mouseover(function(){u(e.contentDivId).css("overflow","auto")}).mouseout(function(){u(e.contentDivId).css("overflow","hidden")}),t("__initWidgetList out")}function o(){0===u(e.contentDivId).find("li").length?u("#meceNoNotificationsDiv").text(n("no_messages")):u("#meceNoNotificationsDiv").text(""),c(!1)}function a(t,n){var i=function(){var e=n[7]?"https://rawgit.com/UniversityofHelsinki/mece-client/master/images/avatar.png":"https://rawgit.com/UniversityofHelsinki/mece-client/master/images/avatar-group.png",t=n[5];return t||e},o=function(e){var t=v;return e?e.length>t?e.slice(0,t)+"...":e:""},a=function(e,t){return moment(e).locale(t).calendar()},c=u(e.contentDivId).find("ul"),r=n[8][g].link||n[2],s=n[8][g].linkText||n[3],d=n[8][g].message||n[1],l=(n[8][g].link||n[4],u("<div>").html(s).contents()),m=u("<a>").attr("href",r);m.prepend(l);var f=u("<img>").attr("src",i()).text("avatar image"),p=u("<div>").append(m).addClass("mece-msg-title"),h=u("<div>").html(o(d)).addClass("mece-msg-content"),y=u("<div>").text(a(n[6],g)).addClass("mece-msg-received"),I=u("<div>").addClass("mece-notification-detail-view"),D=u("<div>").addClass("mece-avatar").append(f),k=u("<div>").addClass("mece-notification-fields").append(p).append(h).append(y);I.append(D).append(k);var L=u("<li>").attr("id",n[0]).addClass("mece-msg-item");n[7]?L.addClass("mece-private-message"):L.addClass("mece-public-message"),n[7]&&n[7].read&&L.addClass("mece-read-message"),L.prepend(I),c.prepend(L)}function c(t){var n=u(e.contentDivId).find("ul li.mece-private-message").filter("li:not(.mece-read-message)").length;n>0&&(t?u(e.iconDivId).append(u("<span>").attr("id","unread-count").text(n).addClass("mece-badge")):u(e.unreadCountSpanId).html(u("<span>").text(n)))}function r(){u(document).ready(function(){u("ul").on("click","li.mece-private-message",function(){u.ajax({url:f+this.id,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){u("#"+e._id).addClass("mece-read-message"),c(!1)},error:function(e,t,n){console.log(e.responseText)}})})})}function s(){function n(){u(".dialog").fadeOut(200),u(e.iconDivId).removeClass("active")}t("dialog");var i="https://rawgit.com/UniversityofHelsinki/mece-client/master/images/bell.png";u(e.iconDivId).append(u("<img>").attr("src",i).text("bell image")),u(e.iconDivId).click(function(e){e.stopPropagation(),u(this).hasClass("active")?(u(".dialog").fadeOut(200),u(this).removeClass("active")):(u(".dialog").delay(25).fadeIn(200),u(this).addClass("active"))}),u(document.body).click(function(e){n()}),u(".dialog").click(function(e){e.stopPropagation()}),t("dialog out")}function d(){t("init"),!e.view.ready&&l()&&(t("init !mece.view.ready && dependenciesLoaded()"),u=u||e.jQuery,i(),c(!0),s(),r(),e.controller&&e.controller.initialized&&e.controller.start(),e.view.ready=!0,g=u(e.contentDivId).attr("language")||g),t("init out")}function l(){return e.initializer&&e.initializer.ready&&e.loggedIn}function m(e){var t=e.sort(function(e,t){return e[6]>t[6]});u.each(t,function(e,t){a(e,t)})}var u,f="https://ohtu-devel.it.helsinki.fi/mece/notifications/markRead/",v=58,g="fi",p={no_messages:{en:"No messages",fi:"Ei viestejä",sv:"Inga meddelanden"}};return function(){t("bootstrap"),e.view={init:d,notifications:{add:m,check:o}},e.view.init(),t("bootstrap out")}(),e}(meceNotifications||{});