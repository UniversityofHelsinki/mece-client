var meceNotifications=function(e){function n(){var n=document.createElement("iframe");n.style.display="none",n.src=t,n.addEventListener("load",function(){setTimeout(function(){e.loggedIn=!0,e.controller&&e.controller.init(),e.view&&e.view.init()},1e3)},!1),n.addEventListener("error",function(){},!1),document.body.appendChild(n)}var t="https://ohtu-devel.it.helsinki.fi/Shibboleth.sso/HYLogin";return n(),e}(meceNotifications||{}),meceNotifications=function(e){function n(){return l(e.contentDivId).attr("pollingInterval")||m}function t(){return l(e.contentDivId).attr("meceChannels")||f}function i(){return l(e.contentDivId).attr("language")}function a(){var a=i(),o=meceNotifications.view.notifications.setLanguage(a);o&&(g="0"),d=n(),e.channels=t()}function o(){!e.controller.ready&&c()&&(l=l||e.jQuery,a(),s(),e.controller.ready=!0)}function c(){return e.initializer&&e.initializer.ready&&e.loggedIn}function r(){var n={channelNames:e.channels.split(v).map(function(e){return e.trim()})};"0"!==g&&(n.startingTime=g);var t=u+"/notifications?"+l.param(n);return l.ajax({url:t,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){return e},error:function(e,n,t){console.log(e.responseText)}})}function s(){e.controller.running||(setInterval(function(){a(),r().done(function(e){var n=e;n.sort(function(e,n){return e.submitted>n.submitted}),n.length>0&&(g=n[n.length-1].received,meceNotifications.view.notifications.add(n.map(function(e){var n={en:{heading:e.headingEN,message:e.messageEN,link:e.linkEN,linkText:e.linkTextEN},fi:{heading:e.headingFI,message:e.messageFI,link:e.linkFI,linkText:e.linkTextFI},sv:{heading:e.headingSV,message:e.messageSV,link:e.linkSV,linkText:e.linkTextSV}};return[e._id,e.message,e.link,e.linkText,e.heading,e.avatar,e.received,e._recipients?e._recipients[0]:null,p?n:{en:{},fi:{},sv:{}}]})))},function(e){}),meceNotifications.view.notifications.check()},d),e.controller.running=!0)}var d,l,u="https://ohtu-devel.it.helsinki.fi/mece",m=4e3,f="",v=",",g="0",p=!0;return function(){e.controller={init:o,start:s},e.controller.init()}(),e}(meceNotifications||{}),meceNotifications=function(e){function n(){e.initializer.ready=!0,e.controller&&e.controller.init(),e.view&&e.view.init()}function t(){if(void 0===window.moment){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src","https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment-with-locales.min.js"),(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)}}function i(){if(void 0===window.jQuery||window.jQuery.fn.jquery!==o){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src","https://ajax.googleapis.com/ajax/libs/jquery/"+o+"/jquery.min.js"),t.readyState?t.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&(e.jQuery=window.jQuery.noConflict(!0),console.log(e.jQuery),n())}:t.onload=function(){e.jQuery=window.jQuery.noConflict(!0),n()},(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(t)}else e.jQuery=window.jQuery,n()}function a(){function e(){"undefined"!=typeof moment?(moment.locale("fi",{calendar:{sameDay:function(){return"["+moment(this).locale("fi").fromNow()+"]"},nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"}}),moment.locale("sv",{calendar:{sameDay:function(){return"["+moment(this).locale("sv").fromNow()+"]"},nextDay:"[Imorgon] LT",lastDay:"[Igår] LT",nextWeek:"[På] dddd LT",lastWeek:"[I] dddd[s] LT",sameElse:"L"}}),moment.locale("en",{calendar:{sameDay:function(){return"["+moment(this).locale("en").fromNow()+"]"},nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"}})):setTimeout(function(){e()},250)}e()}var o="1.11.3";return e.contentDivId="#mece-content-div",e.iconDivId="#mece-icon-div",e.unreadCountSpanId="#unread-count",e.jQuery=null,function(){e.initializer={init:n},t(),a(),i()}(),e}(meceNotifications||{}),meceNotifications=function(e){function n(e,n){return h[e][n||p]}function t(){f(e.contentDivId).append(f("<ul/>").addClass("mece-list")),f(e.contentDivId).append(f("<div/>").attr("ID","meceNoNotificationsDiv")),f(e.contentDivId).mouseover(function(){f(e.contentDivId).css("overflow","auto")}).mouseout(function(){f(e.contentDivId).css("overflow","hidden")})}function i(){0===f(e.contentDivId).find("li").length?f("#meceNoNotificationsDiv").text(n("no_messages")):f("#meceNoNotificationsDiv").text(""),o(!1)}function a(n,t){var i=function(){var e="";e=t[7]?"images/avatar.png":"images/users.png";var n=t[5];return n||e},a=function(e){var n=g;return e?e.length>n?e.slice(0,n)+"...":e:""},o=function(e,n){return moment(e).locale(n).calendar()},c=f(e.contentDivId).find("ul"),r=t[8][p].link||t[2],s=t[8][p].linkText||t[3],d=t[8][p].message||t[1],l=(t[8][p].link||t[4],f("<div>").html(s).contents()),u=f("<a>").attr("href",r);u.prepend(l);var m=f("<img>").attr("src",i()).text("avatar image"),v=f("<div>").append(u).addClass("mece-msg-title"),h=f("<div>").html(a(d)).addClass("mece-msg-content"),y=f("<div>").text(o(t[6],p)).addClass("mece-msg-received"),D=f("<div>").addClass("mece-notification-detail-view"),k=f("<div>").addClass("mece-avatar").append(m),I=f("<div>").addClass("mece-notification-fields").append(v).append(h).append(y);D.append(k).append(I);var T=f("<li>").attr("id",t[0]).addClass("mece-msg-item");t[7]?T.addClass("mece-private-message"):T.addClass("mece-public-message"),t[7]&&t[7].read&&T.addClass("mece-read-message"),T.prepend(D),c.prepend(T)}function o(n){var t=f(e.contentDivId).find("ul li.mece-private-message").filter("li:not(.mece-read-message)").length;n?f(e.iconDivId).append(f("<span>").attr("id","unread-count").text(t).addClass("mece-badge")):f(e.unreadCountSpanId).html(f("<span>").text(t))}function c(){f(document).ready(function(){f("ul").on("click","li.mece-private-message",function(){f.ajax({url:v+this.id,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){f("#"+e._id).addClass("mece-read-message"),o(!1)},error:function(e,n,t){console.log(e.responseText)}})})})}function r(){function n(){f(".dialog").fadeOut(200),f(e.iconDivId).removeClass("active")}var t="images/bell.png";f(e.iconDivId).append(f("<img>").attr("src",t).text("bell image")),f(e.iconDivId).click(function(e){e.stopPropagation(),f(this).hasClass("active")?(f(".dialog").fadeOut(200),f(this).removeClass("active")):(f(".dialog").delay(25).fadeIn(200),f(this).addClass("active"))}),f(document.body).click(function(e){n()}),f(".dialog").click(function(e){e.stopPropagation()})}function s(){!e.view.ready&&d()&&(f=f||e.jQuery,t(),o(!0),r(),c(),e.controller&&e.controller.initialized&&e.controller.start(),e.view.ready=!0,p=f(e.contentDivId).attr("language")||p)}function d(){return e.initializer&&e.initializer.ready&&e.loggedIn}function l(){f(".mece-list").remove(),t()}function u(e){return p!==e?(p=e,l(),!0):!1}function m(e){var n=e.sort(function(e,n){return e[6]>n[6]});f.each(n,function(e,n){a(e,n)})}var f,v="https://ohtu-devel.it.helsinki.fi/mece/notifications/markRead/",g=58,p="fi",h={no_messages:{en:"No messages",fi:"Ei viestejä",sv:"Inga meddelanden"}};return function(){e.view={init:s,notifications:{add:m,check:i,setLanguage:u}},e.view.init()}(),e}(meceNotifications||{});