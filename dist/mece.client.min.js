!function(){"use strict";function e(e,t){return"undefined"!=typeof moment?moment(e).locale(t).calendar():void 0}function t(e){var t=!0;t&&console.log("module: MECE-CLIENT -- "+e+" : "+Date().toString())}function n(){D(document).ready(function(){i(),l(),h(),L(),k(),a()})}function i(){t("initializerStuff in"),r(),b=D(G).attr("mece-domain")||S,E=D(G).attr("mece-username"),K.windowLeftOffset=parseInt(D(G).attr("mece-window-left-offset")),K.windowTopOffset=parseInt(D(G).attr("mece-window-top-offset")),K.windowTopOffsetCollapsed=parseInt(D(G).attr("mece-window-top-offset-collapsed")),K.windowWidth=parseInt(D(G).attr("mece-window-width")),K.windowHeight=parseInt(D(G).attr("mece-window-height")),K.collapseWidth=parseInt(D(G).attr("mece-collapse-width")),I=D(G).attr("mece-token"),H=D(G).attr("mece-language"),!H||"fi"!==H&&"sv"!==H&&"en"!==H||(H=H),u(),t("initializerStuff out")}function a(){t("start"),w(),o(),setInterval(function(){w(),o(),v()},j)}function o(){t("fetchNotifications"),s().done(function(e){g(N),d(e),v()}).fail(function(e){t("ERROR "+e)})}function s(){var e={};"0"!==Y&&(e.startingTime=Y),e.token=I;var t=b+"/mece/api/notifications?"+D.param(e);return D.ajax({url:t,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){return N+=e.length,e},error:function(e,t,n){console.log(e.responseText)}})}function d(e){var t,n=e;n&&n.length>0&&c(n),n.sort(function(e,t){return new Date(e.submitted)-new Date(t.submitted)}),n.length>0&&C(n.map(function(e){return t={en:{heading:e.headingEN,message:e.messageEN,link:e.linkEN,linkText:e.linkTextEN},fi:{heading:e.headingFI,message:e.messageFI,link:e.linkFI,linkText:e.linkTextFI},sv:{heading:e.headingSV,message:e.messageSV,link:e.linkSV,linkText:e.linkTextSV}},[e._id,e.message,e.link,e.linkText,e.heading,e.avatarImageUrl,e.received,M?t:{en:{},fi:{},sv:{}},e.submitted,e.read]}))}function c(e){D.each(e,function(e,t){Y<t.received&&(Y=t.received)})}function l(){function e(){return D(G).attr("mece-polling-interval")}j=e()}function r(){if(void 0===window.moment){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src","https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment-with-locales.min.js"),(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)}}function m(){var e;void 0===window.jQuery||window.jQuery.fn.jquery!==q?(e=document.createElement("script"),e.setAttribute("type","text/javascript"),e.setAttribute("src","https://ajax.googleapis.com/ajax/libs/jquery/"+q+"/jquery.min.js"),e.readyState?e.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&(D=window.jQuery.noConflict(!0),t("jQuery loaded"),n())}:e.onload=function(){D=window.jQuery.noConflict(!0),t("browsers"),n()},(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)):(D=window.jQuery,t("The jQuery version on the window is the one we want to use"),n())}function u(){function e(){"undefined"!=typeof moment?(moment.locale("fi",{calendar:{sameDay:function(){return"["+moment(this).locale("fi").fromNow()+"]"},nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"}}),moment.locale("sv",{calendar:{sameDay:function(){return"["+moment(this).locale("sv").fromNow()+"]"},nextDay:"[Imorgon] LT",lastDay:"[Igår] LT",nextWeek:"[På] dddd LT",lastWeek:"[I] dddd[s] LT",sameElse:"L"}}),moment.locale("en",{calendar:{sameDay:function(){return"["+moment(this).locale("en").fromNow()+"]"},nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"}}),w()):setTimeout(function(){e()},250)}e()}function f(e,t){return P[e][t||H]}function p(){var e=K.windowWidth,t=K.windowHeight,n=D("#mece").position().left,i=D(window).width(),a="relative",o=0,s="50px",d=D("#mece").position().top+K.windowTopOffset;i<K.collapseWidth?(s="100%",a="absolute",e="100%",o=0,d=D("#mece").position().top+K.windowTopOffsetCollapsed):e>i?(a="absolute",e=i+"px",o=-n):n+e/2>i?(a="absolute",o=i-n-e):e/2>n?(a="absolute",o=-n):(a="absolute",o=-e+30),D("#mece").css("position","relative").css("width",s),D(G).css("position",a).css("left",o+"px").css("top",d+"px").css("width",e).css("height",t)}function h(){D(G).append(D("<ul/>").css("position","absolute").addClass("mece-list")),g(N),D(G).append(D("<div/>").attr("ID","meceNoNotificationsDiv")),p()}function g(e){0===e||1===e?D(G).css("height","100px"):2===e?D(G).css("height","200px"):3===e?D(G).css("height","300px"):D(G).css("height","350px")}function v(){0===D(G).find("li").length?D("#meceNoNotificationsDiv").text(f("no_messages")):D("#meceNoNotificationsDiv").text(""),T(!1)}function w(){D(G).find("ul").each(function(){D(this).find("li").each(function(){var t=D(this).find(".hiddenSubmittedTime").first().text(),n=D(this).find("."+B).first();n&&t&&n.text(e(t,H))})})}function x(e,t){console.log("Seeking field "+e+" for language "+H);var n={fi:"sv",sv:"en",en:"fi"},i=H,a=t[A][i][e];return a||(i=n[i],a=t[A][i][e]),a||(i=n[i],a=t[A][i][e]),a}function y(t,n){var i=function(){var e=_+"/avatar.png",t=n[z];return t||e},a=D(G).find("ul"),o=x("link",n)||n[F],s=x("linkText",n)||n[Q],d=x("message",n)||n[O],c=D("<div>").html(s).contents(),l=D("<a>").attr("href",o).attr("target","_blank").prepend(c),r=D("<img>").attr("src",i()).text("avatar image").addClass("mece-avatar-picture"),m=D("<div>").addClass("mece-avatar").append(r),u=D("<div>").append(l).addClass("mece-msg-title"),f=D("<div>").html(d).addClass("mece-msg-content"),p=D("<div>").text(e(n[R],H)).addClass("mece-msg-received"),h=D("<div>").addClass("mece-notification-fields").append(u).append(f).append(p),g=D("<div style='display: none' class='hiddenSubmittedTime'>").text(n[R]),v=D("<div>").addClass("mece-notification-detail-view").append(m).append(h).append(g),w=D("<li>").attr("id",n[W]).addClass("mece-msg-item");w.addClass("mece-private-message");var y=K.windowWidth-13;v.css("width",y+"px"),n[V]&&w.addClass("mece-read-message"),w.prepend(v),a.prepend(w)}function T(e){var t=D(G).find("ul li.mece-private-message").filter("li:not(.mece-read-message)").length;0===D(J).length?D(U).append(D("<span>").attr("id","unread-count").text(t).addClass("mece-badge")):D(J).text(t),0===t&&D(J).remove()}function k(){D(document).ready(function(){D("ul").on("click","li.mece-private-message",function(){if(!D(this).hasClass("mece-read-message")){var e={};e.token=I,e.id=this.id;var t=b+"/mece/api/notifications/markRead?"+D.param(e);D.ajax({url:t,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){D("#"+e[0].notificationId).addClass("mece-read-message"),T(!1)},error:function(e,t,n){console.log(e.responseText)}})}})})}function L(){function e(){D(".dialog").fadeOut(200),D(U).removeClass("active")}D(U).append('<svg width="20" height="20" viewBox="0 0 1792 1792" fill="#178feb" xmlns="http://www.w3.org/2000/svg"><path d="M912 1696q0-16-16-16-59 0-101.5-42.5t-42.5-101.5q0-16-16-16t-16 16q0 73 51.5 124.5t124.5 51.5q16 0 16-16zm816-288q0 52-38 90t-90 38h-448q0 106-75 181t-181 75-181-75-75-181h-448q-52 0-90-38t-38-90q50-42 91-88t85-119.5 74.5-158.5 50-206 19.5-260q0-152 117-282.5t307-158.5q-8-19-8-39 0-40 28-68t68-28 68 28 28 68q0 20-8 39 190 28 307 158.5t117 282.5q0 139 19.5 260t50 206 74.5 158.5 85 119.5 91 88z"/></svg>'),D(U).click(function(e){e.stopPropagation(),D(this).hasClass("active")?(D(".dialog").fadeOut(200),D(this).removeClass("active")):(D(".dialog").delay(25).fadeIn(200),D(this).addClass("active"))}),D(document.body).click(function(t){e()}),D(".dialog").click(function(e){e.stopPropagation()})}function C(e){D.each(e,function(e,t){y(e,t)})}var j,D,b,E,I,N=0,Y="0",M=!0,q="1.11.3",S="https://mece.it.helsinki.fi",H="fi",W=0,O=1,F=2,Q=3,z=5,A=7,R=8,V=9,_="https://rawgit.com/UniversityofHelsinki/mece-client/master/images",B="mece-msg-received",P={no_messages:{en:"No messages",fi:"Ei viestejä",sv:"Inga meddelanden"}},G="#mece-content-div",U="#mece-icon-div",J="#unread-count",D=null,K={};window.onload=function(){m()}}();