var meceNotifications=function(e){return e.loggedIn=!0,e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: CONTROLLER -- "+e+" : "+Date().toString())}function n(){return l(e.contentDivId).attr("pollingInterval")||m}function i(){return l(e.contentDivId).attr("meceChannels")||u}function o(){r=n(),e.channels=i()}function a(){t("init"),!e.controller.ready&&d()&&(t("init !mece.controller.ready && dependenciesLoaded()"),l=l||e.jQuery,o(),s(),e.controller.ready=!0),t("init out")}function d(){return e.initializer&&e.initializer.ready&&e.loggedIn}function c(){var t={channelNames:e.channels.split(f).map(function(e){return e.trim()})};"0"!==p&&(t.startingTime=p);var n=e.domain+"/mece/notifications?"+l.param(t);return l.ajax({url:n,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){return e},error:function(e,t,n){console.log(e.responseText)}})}function s(){t("start"),e.controller.running||(setInterval(function(){meceNotifications.view.notifications.updateTime(),c().done(function(e){var t=e;t&&t.length>0&&(p=t[0].received),t.sort(function(e,t){return new Date(t.submitted)-new Date(e.submitted)}),t.length>0&&meceNotifications.view.notifications.add(t.map(function(e){var t={en:{heading:e.headingEN,message:e.messageEN,link:e.linkEN,linkText:e.linkTextEN},fi:{heading:e.headingFI,message:e.messageFI,link:e.linkFI,linkText:e.linkTextFI},sv:{heading:e.headingSV,message:e.messageSV,link:e.linkSV,linkText:e.linkTextSV}};return[e._id,e.message,e.link,e.linkText,e.heading,e.avatarImageUrl,e.received,e._recipients?e._recipients[0]:null,g?t:{en:{},fi:{},sv:{}},e.submitted]}))},function(e){}),meceNotifications.view.notifications.check()},r),e.controller.running=!0)}var r,l,m=4e3,u="",f=",",p="0",g=!0;return function(){t("bootstrap"),e.controller={init:a,start:s},e.controller.init(),t("bootstrap out")}(),e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: INITIALIZER -- "+e+" : "+Date().toString())}function n(){t("init"),e.initializer.ready=!0,e.domain=$(e.contentDivId).attr("meceDomain")||s,e.config.windowLeftOffset=$(e.contentDivId).attr("meceWindowLeftOffset")||r,e.config.windowTopOffset=$(e.contentDivId).attr("meceWindowTopOffset")||l,e.config.windowWidth=$(e.contentDivId).attr("meceWindowWidth")||m,e.config.windowHeight=$(e.contentDivId).attr("meceWindowHeight")||u,e.controller&&(t("mece.controller"),e.controller.init()),e.view&&(t("mece.view"),e.view.init()),t("init out")}function i(){if(void 0===window.moment){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src","https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment-with-locales.min.js"),(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)}}function o(){var n="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css";if(window.bootstrap)e.bootstrap=window.bootstrap,t("loading bootstrap .. OK");else{t("loading bootstrap ..");var i=document.createElement("script"),o=document.createElement("link");o.setAttribute("rel","stylesheet"),o.setAttribute("href",n),i.readyState&&(i.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&(e.bootstrap=window.bootstrap,t("mece.bootstrap:"+e.bootstrap))}),(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(i),(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o),t("loading bootstrap .. OK")}}function a(){if(void 0===window.jQuery||window.jQuery.fn.jquery!==c){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src","https://ajax.googleapis.com/ajax/libs/jquery/"+c+"/jquery.min.js"),t.readyState?t.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&(e.jQuery=window.jQuery.noConflict(!0),console.log(e.jQuery),n())}:t.onload=function(){e.jQuery=window.jQuery.noConflict(!0),n()},(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(t)}else e.jQuery=window.jQuery,n()}function d(){function e(){"undefined"!=typeof moment?(moment.locale("fi",{calendar:{sameDay:function(){return"["+moment(this).locale("fi").fromNow()+"]"},nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"}}),moment.locale("sv",{calendar:{sameDay:function(){return"["+moment(this).locale("sv").fromNow()+"]"},nextDay:"[Imorgon] LT",lastDay:"[Igår] LT",nextWeek:"[På] dddd LT",lastWeek:"[I] dddd[s] LT",sameElse:"L"}}),moment.locale("en",{calendar:{sameDay:function(){return"["+moment(this).locale("en").fromNow()+"]"},nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"}})):setTimeout(function(){e()},250)}e()}var c="1.11.3",s="https://mece.it.helsinki.fi",r=250,l=35,m=300,u=350;return e.contentDivId="#mece-content-div",e.iconDivId="#mece-icon-div",e.unreadCountSpanId="#unread-count",e.jQuery=null,e.config={},function(){t("bootstrap"),e.initializer={init:n},i(),d(),a(),o(),t("bootstrap out")}(),e}(meceNotifications||{}),meceNotifications=function(e){function t(e){console.log("module: VIEW -- "+e+" : "+Date().toString())}function n(e,t){return x[e][t||p]}function i(){t("__initWidgetList"),t("position:"+[f(e.iconDivId).position().top,f(e.iconDivId).position().left]),f(e.contentDivId).css("position","absolute").css("top",f(e.iconDivId).position().top+e.config.windowTopOffset).css("left",f(e.iconDivId).position().left-e.config.windowLeftOffset).css("width",e.config.windowWidth).css("height",e.config.windowHeight).append(f("<ul/>").addClass("mece-list")),t("__initWidgetList:position: "+JSON.stringify({left:f(e.iconDivId).position().left,top:f(e.iconDivId).position().top})),f(e.contentDivId).append(f("<div/>").attr("ID","meceNoNotificationsDiv")),f(e.contentDivId).mouseover(function(){f(e.contentDivId).css("overflow","auto")}).mouseout(function(){f(e.contentDivId).css("overflow","hidden")}),t("__initWidgetList out")}function o(){0===f(e.contentDivId).find("li").length?f("#meceNoNotificationsDiv").text(n("no_messages")):f("#meceNoNotificationsDiv").text(""),c(!1)}function a(){f(e.contentDivId).find("ul").each(function(){f(this).find("li").each(function(){var e=f(this).find(".hiddenSubmittedTime").first().text(),t=f(this).find("."+k).first();t&&e&&t.text(N(e,p))})})}function d(t,n){var i=function(){var e=L+(n[I]?"/avatar.png":"/avatar-group.png"),t=n[D];return t||e},o=f(e.contentDivId).find("ul"),a=n[T][p].link||n[h],d=n[T][p].linkText||n[w],c=n[T][p].message||n[v],s=(n[T][p].link||n[y],f("<div>").html(d).contents()),r=f("<a>").attr("href",a);r.prepend(s);var l=f("<img>").attr("src",i()).text("avatar image").addClass("mece-avatar-picture"),m=f("<div>").addClass("mece-avatar").append(l),u=f("<div>").append(r).addClass("mece-msg-title"),k=f("<div>").html(c).addClass("mece-msg-content"),x=f("<div>").text(N(n[b],p)).addClass("mece-msg-received"),C=f("<div>").addClass("mece-notification-fields").append(u).append(k).append(x),j=f("<div style='display: none' class='hiddenSubmittedTime'>").text(n[b]),E=f("<div>").addClass("mece-notification-detail-view").append(m).append(C).append(j),S=f("<li>").attr("id",n[g]).addClass("mece-msg-item");n[I]?S.addClass("mece-private-message"):S.addClass("mece-public-message"),n[I]&&n[I].read&&S.addClass("mece-read-message"),S.prepend(E),o.prepend(S)}function c(t){var n=f(e.contentDivId).find("ul li.mece-private-message").filter("li:not(.mece-read-message)").length;0===f(e.unreadCountSpanId).length?f(e.iconDivId).append(f("<span>").attr("id","unread-count").text(n).addClass("mece-badge")):f(e.unreadCountSpanId).html(f("<span>").text(n)),0===n&&f(e.unreadCountSpanId).remove()}function s(){f(document).ready(function(){f("ul").on("click","li.mece-private-message",function(){f.ajax({url:e.domain+"/mece/notifications/markRead/"+this.id,type:"GET",crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){f("#"+e._id).addClass("mece-read-message"),c(!1)},error:function(e,t,n){console.log(e.responseText)}})})})}function r(){function n(){f(".dialog").fadeOut(200),f(e.iconDivId).removeClass("active")}t("dialog"),f(e.iconDivId).append(f("<img>").attr("src",L+"/bell.png").text("bell image")),f(e.iconDivId).click(function(e){e.stopPropagation(),f(this).hasClass("active")?(f(".dialog").fadeOut(200),f(this).removeClass("active")):(f(".dialog").attr("position","absolute"),f(".dialog").delay(25).fadeIn(200),f(this).addClass("active"))}),f(document.body).click(function(e){n()}),f(".dialog").click(function(e){e.stopPropagation()}),t("dialog out")}function l(){t("init"),!e.view.ready&&m()&&(t("init !mece.view.ready && dependenciesLoaded()"),f=f||e.jQuery,i(),c(!0),r(),s(),e.controller&&e.controller.initialized&&e.controller.start(),e.view.ready=!0,p=f(e.contentDivId).attr("language")||p),t("init out")}function m(){return e.initializer&&e.initializer.ready&&e.loggedIn}function u(e){f.each(e,function(e,t){d(e,t)})}var f,p="fi",g=0,v=1,h=2,w=3,y=4,D=5,I=7,T=8,b=9,L="https://rawgit.com/UniversityofHelsinki/mece-client/master/images",k="mece-msg-received",x={no_messages:{en:"No messages",fi:"Ei viestejä",sv:"Inga meddelanden"}},N=function(e,t){return moment(e).locale(t).calendar()};return function(){t("bootstrap"),e.view={init:l,notifications:{add:u,check:o,updateTime:a}},e.view.init(),t("bootstrap out")}(),e}(meceNotifications||{});